# 单表操作

## 查询表中所有字段
### A
实际应用中会出现查询所有店铺信息的情况,比如查询 basic 表中的所有字段的结果

```sql
explain select *
from basic;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra |
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | NULL  |
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
1 rows in set (0.05 sec)
```

可见 rows 为 963 ,因为表创建时已经自带以主键为关键值的索引,无需优化

## 查询表中指定字段
### A
实际应用中会出现查询所有店铺的名称的情况,比如查询 basic 表中的 name 字段的结果

```sql
explain select name
from basic;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra |
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | NULL  |
+----+-------------+-------+------+---------------+------+---------+------+------+-------+
1 rows in set (0.05 sec)
```

可见 rows 为 963 ,因为表创建时已经自带以主键为关键值的索引,无需优化

## 查询表中没有重复的字段 (distinct) 的使用
### A
实际应用中会出现查询不重名的所有店铺名称的情况,比如查询 basic 表中没有重复的
name 字段的结果

```sql
explain select distinct name
from basic;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-----------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra           |
+----+-------------+-------+------+---------------+------+---------+------+------+-----------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | Using temporary |
+----+-------------+-------+------+---------------+------+---------+------+------+-----------------+
1 rows in set (0.05 sec)
```

可见 rows 为 963 ,因为表创建时已经自带以主键为关键值的索引,无需优化

## 条件查询各表主键的字段(单值查询或范围查询)
### A
实际应用中会出现用一个精确的店编号去查找店铺信息的情况,比如查找 basic 中
shop_id=10328540 的店铺信息

```sql
explain select *
from basic
where shop_id=10328540;
```

```
+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+
| id | select_type | table | type  | possible_keys | key     | key_len | ref   | rows | Extra |
+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+
| 1  | SIMPLE      | basic | const | PRIMARY       | PRIMARY | 4       | const | 1    | NULL  |
+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+
1 rows in set (0.05 sec)
```

可见 rows 已经为 1 ,因为表创建时已经自带以主键为关键值的索引,无需优化

### B
实际应用中会出现用一个店编号范围去查找一部分店铺信息的情况,比如查找 basic 中
shop_id>10328540 and shop_id<10329940 的店铺信息

```sql
explain select *
from basic
where shop_id>10328540 and shop_id<10329940;
```

```
+----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+
| id | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | Extra       |
+----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | range | PRIMARY       | PRIMARY | 4       | NULL | 36   | Using where |
+----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+
1 rows in set (0.01 sec)
```

可见 rows 已经为 36 ,因为表创建时已经自带以主键为关键值的索引,无需优化

##条件查询各表中普通字段(单值查询或范围查询)
### A
实际应用中会出现用店名来查找店铺信息的情况,比如查找 base 中 name 为「林师傅」的结
果

```sql
explain select *
from basic
where name='林师傅';
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.03 sec)
```

可见 rows 为 963

经过优化：对 name 进行索引

```sql
create index index_name on basic(name);
```

再次查找

```
+----+-------------+-------+------+---------------+------------+---------+-------+------+-----------------------+
| id | select_type | table | type | possible_keys | key        | key_len | ref   | rows | Extra                 |
+----+-------------+-------+------+---------------+------------+---------+-------+------+-----------------------+
| 1  | SIMPLE      | basic | ref  | index_name    | index_name | 150     | const | 1    | Using index condition |
+----+-------------+-------+------+---------------+------------+---------+-------+------+-----------------------+
1 rows in set (0.04 sec)
```

可见 rows 已经变为 1,是优化前的 0.1%


### B
实际应用中会出现查找人均消费小于 50 元的店铺名称的情况,比如查找 base 中
avg_price<50 的结果

```sql
explain select name
from basic
where avg_price<50;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.03 sec)
```

可见 rows 为 963

经过优化：对 avg_price,name 进行索引

```sql
create index index_name_price on basic(avg_price,name);
```

再次查找

```
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
| id | select_type | table | type  | possible_keys    | key              | key_len | ref  | rows | Extra                    |
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
| 1  | SIMPLE      | basic | range | index_name_price | index_name_price | 2       | NULL | 617  | Using where; Using index |
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
1 rows in set (0.05 sec)
```

可见 rows 已经变为 617 ,是优化前的 64%

##􏰤􏰥􏰁􏰆􏰦􏰥􏰊􏰋􏰗􏰘􏰄􏰅一个表中多个字段条件查询(单值查询或范围查询)
### A	
实际应用中会出现用店名和人均消费值来查找店铺信息的情况,比如查找 base 中 name 为“林师傅”且 avg_price=12 的结果
```sql
explain select *
from basic
where name='林师傅' and avg_price=12;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.05 sec)
```

可见 rows 为 963

经过优化:对 avg_price,name 进行索引
```sql
create index index_name on basic(avg_price,name);
```

再次查找

```
+----+-------------+-------+------+---------------+------------+---------+-------------+------+-----------------------+
| id | select_type | table | type | possible_keys | key        | key_len | ref         | rows | Extra                 |
+----+-------------+-------+------+---------------+------------+---------+-------------+------+-----------------------+
| 1  | SIMPLE      | basic | ref  | index_name    | index_name | 152     | const,const | 1    | Using index condition |
+----+-------------+-------+------+---------------+------------+---------+-------------+------+-----------------------+
1 rows in set (0.04 sec)
```

可见 rows 已经变为 1 ,是优化前的 0.1%


### B
实际应用中会出现查找店名和人均消费范围的店铺名称的情况,比如查找 base 中 avg_price<50 的结果
```sql
explain select name
from basic
where name='林师傅' and avg_price<50;
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 1000 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.04 sec)
```

可见 rows 为 1000

经过优化:对 avg_price,name 进行索引
```sql
create index index_name_price on basic(avg_price,name);
```

再次查找

```
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
| id | select_type | table | type  | possible_keys    | key              | key_len | ref  | rows | Extra                    |
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
| 1  | SIMPLE      | basic | range | index_name_price | index_name_price | 2       | NULL | 617  | Using where; Using index |
+----+-------------+-------+-------+------------------+------------------+---------+------+------+--------------------------+
1 rows in set (0.05 sec)
```

可见 rows 已经变为 617 ,是优化前的 61.7%

## 用"in"条件进行查询
### A
实际应用中会出现查找几个店名的店铺的情况,比如查找 base 中 name 包含于 {真好味,阿姨布丁,青春学堂} 中的结果

```sql
explain select *
from basic
where name in ('真好味','阿姨布丁','青春学堂');
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | basic | ALL  | NULL          | NULL | NULL    | NULL | 963  | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.05 sec)
```

可见 rows 为 963

经过优化:对 name 进行索引

```sql
create index index_name on basic(name);
```

再次查找

```
+----+-------------+-------+-------+---------------+------------+---------+------+------+-----------------------+
| id | select_type | table | type  | possible_keys | key        | key_len | ref  | rows | Extra                 |
+----+-------------+-------+-------+---------------+------------+---------+------+------+-----------------------+
| 1  | SIMPLE      | basic | range | index_name    | index_name | 150     | NULL | 3    | Using index condition |
+----+-------------+-------+-------+---------------+------------+---------+------+------+-----------------------+
1 rows in set (0.04 sec)
```

可见 rows 已经变为 3 ,是优化前的 0.3%

## 一个表中 group by,order by,having 联合查询
### A
实际应用中会出现分组排序筛选查找的情况,比如将 remark 按环境评分 environment_rating 分组,筛选出食品评分 product_rating > 7 的餐馆, 并且按平均评价数量 all_remarks 排序

```sql
explain select shop_id,environment_rating,product_rating,all_remarks
from remark
group by environment_rating
having product_rating>7
order by all_remarks;
```

```
+----+-------------+--------+------+---------------+------+---------+------+------+---------------------------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra                           |
+----+-------------+--------+------+---------------+------+---------+------+------+---------------------------------+
| 1  | SIMPLE      | remark | ALL  | NULL          | NULL | NULL    | NULL | 1000 | Using temporary; Using filesort |
+----+-------------+--------+------+---------------+------+---------+------+------+---------------------------------+
1 rows in set (0.03 sec)
```

可见 rows 为 1000

经过优化:对 environment_rating,product_rating,all_remarks 进行索引

```sql
create index index_environment_rating,product_rating,all_remarks on remark(environment_rating,product_rating,all_remarks);
```

再次查找

```
+----+-------------+--------+-------+---------------+---------+---------+------+------+-----------------------------------------------------------+
| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra                                                     |
+----+-------------+--------+-------+---------------+---------+---------+------+------+-----------------------------------------------------------+
| 1  | SIMPLE      | remark | range | index_1       | index_1 | 5       | NULL | 84   | Using index for group-by; Using temporary; Using filesort |
+----+-------------+--------+-------+---------------+---------+---------+------+------+-----------------------------------------------------------+
1 rows in set (0.06 sec)
```

可见 rows 已经变为 84 ,是优化前的 0.84%


# 复合查询

## 多表联合查询

### A
实际情况中会出现多表联合查询的情况，比如寻找平均价格低于 20 元且食物评分高于 8 的店铺

```sql
explain select basic.name,basic.avg_price,remark.product_rating
from basic,remark
where basic.shop_id=remark.shop_id and basic.avg_price<20 and remark.product_rating>8;
```

```
+----+-------------+--------+--------+---------------+---------+---------+--------------------+------+-------------+
| id | select_type | table  | type   | possible_keys | key     | key_len | ref                | rows | Extra       |
+----+-------------+--------+--------+---------------+---------+---------+--------------------+------+-------------+
| 1  | SIMPLE      | basic  | ALL    | PRIMARY       | NULL    | NULL    | NULL               | 1000 | Using where |
| 1  | SIMPLE      | remark | eq_ref | PRIMARY       | PRIMARY | 4       | test.basic.shop_id | 1    | Using where |
+----+-------------+--------+--------+---------------+---------+---------+--------------------+------+-------------+
2 rows in set (0.06 sec)
```

可见 rows 分别为 1000,1

经过优化:对 basic.avg_price, 进行索引

```sql
create index index_avg_price on basic(avg_price);
```
再次查找

```
+----+-------------+--------+--------+-------------------------+-----------------+---------+--------------------+------+-----------------------+
| id | select_type | table  | type   | possible_keys           | key             | key_len | ref                | rows | Extra                 |
+----+-------------+--------+--------+-------------------------+-----------------+---------+--------------------+------+-----------------------+
| 1  | SIMPLE      | basic  | range  | PRIMARY,index_avg_price | index_avg_price | 2       | NULL               | 235  | Using index condition |
| 1  | SIMPLE      | remark | eq_ref | PRIMARY                 | PRIMARY         | 4       | test.basic.shop_id | 1    | Using where           |
+----+-------------+--------+--------+-------------------------+-----------------+---------+--------------------+------+-----------------------+
2 rows in set (0.05 sec)
```

可见 rows 已经变为 235,1 ,是优化前的 23.5%



## 嵌套子查询(select...from(select...))
### A
实际情况中会出现嵌套子查询的情况，比如所有位于杨浦区的店铺 id 和名称与平均价格

```sql
explain select shop_id,name,avg_price
from basic
where shop_id in(select shop_id
				from shop_id_area
				where area='杨浦区');
```

```
+----+-------------+--------------+--------+---------------+---------+---------+---------------------------+------+-------------+
| id | select_type | table        | type   | possible_keys | key     | key_len | ref                       | rows | Extra       |
+----+-------------+--------------+--------+---------------+---------+---------+---------------------------+------+-------------+
| 1  | SIMPLE      | shop_id_area | ALL    | PRIMARY       | NULL    | NULL    | NULL                      | 1000 | Using where |
| 1  | SIMPLE      | basic        | eq_ref | PRIMARY       | PRIMARY | 4       | test.shop_id_area.shop_id | 1    | NULL        |
+----+-------------+--------------+--------+---------------+---------+---------+---------------------------+------+-------------+
2 rows in set (0.04 sec)

```

可见 rows 分别为 1000,1

经过优化:对 shop_id_area 的 area 进行索引

```sql
create index index_shop_id_area on shop_id_area(area);
```
再次查找

```
+----+-------------+--------------+--------+----------------------------+--------------------+---------+---------------------------+------+--------------------------+
| id | select_type | table        | type   | possible_keys              | key                | key_len | ref                       | rows | Extra                    |
+----+-------------+--------------+--------+----------------------------+--------------------+---------+---------------------------+------+--------------------------+
| 1  | SIMPLE      | shop_id_area | ref    | PRIMARY,index_shop_id_area | index_shop_id_area | 120     | const                     | 19   | Using where; Using index |
| 1  | SIMPLE      | basic        | eq_ref | PRIMARY                    | PRIMARY            | 4       | test.shop_id_area.shop_id | 1    | NULL                     |
+----+-------------+--------------+--------+----------------------------+--------------------+---------+---------------------------+------+--------------------------+
2 rows in set (0.03 sec)
```

可见 rows 已经变为 19,1 ,是优化前的 1.9%


# 其他查询
## 向表中插入记录
### A
实际情况中会出现向表中插入记录的情况，插入一座叫“天使城”的城市

```sql
explain insert into city_id_city
values('96','天使城');
```

```
+----+-------------+-------+------+---------------+------+---------+------+------+----------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra          |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------+
| 1  | SIMPLE      | NULL  | NULL | NULL          | NULL | NULL    | NULL | NULL | No tables used |
+----+-------------+-------+------+---------------+------+---------+------+------+----------------+
1 rows in set (0.05 sec)

```

可见 rows 为 NULL,因为此插入操作并没有查询的动作，所以没有记录，也不需要优化

## 删除记录
### A
实际情况中会出现删除记录的情况，比如删除上题中'天使城'这座城市 

```sql
explain delete from city_id_city
where city ='天使城';
```

```
+----+-------------+--------------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table        | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------------+------+---------------+------+---------+------+------+-------------+
| 1  | SIMPLE      | city_id_city | ALL  | NULL          | NULL | NULL    | NULL | 60   | Using where |
+----+-------------+--------------+------+---------------+------+---------+------+------+-------------+
1 rows in set (0.04 sec)

```

可见 rows 为 60

经过优化:对 city 进行索引

```sql
create index index_city on city_id_city(city);
```
再次查找

```
+----+-------------+--------------+-------+---------------+------------+---------+-------+------+-------------+
| id | select_type | table        | type  | possible_keys | key        | key_len | ref   | rows | Extra       |
+----+-------------+--------------+-------+---------------+------------+---------+-------+------+-------------+
| 1  | SIMPLE      | city_id_city | range | index_city    | index_city | 45      | const | 1    | Using where |
+----+-------------+--------------+-------+---------------+------------+---------+-------+------+-------------+
1 rows in set (0.04 sec)
```

可见 rows 已经变为 1 ,是优化前的 1.7%

## 聚集函数
